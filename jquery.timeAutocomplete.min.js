// main lib
(function(a){var b="timeAutocomplete",c=b+".time",d=function(){this.initialize.apply(this,arguments)};d.prototype={el:null,_formatter:null,_calling_from_init:!1,default_opts:{auto_complete:{delay:0,autoFocus:!0,minLength:0},value:"",formatter:"ampm"},initialize:function(b,c){this.options=a.extend(!0,{},this.default_opts,c),this.el=b},_callAutocomplete:function(){if(this.options.auto_complete.source=this._callFormatterMethod("filterSource",this.el,function(){throw Error("You must set a hook_filterSource method in your formatter.")}),a.fn.autocomplete===void 0)throw Error("You need to include the jQuery UI bundle that has the Autocomplete plugin.");this.el.autocomplete(this.options.auto_complete)},_bindEvents:function(){var a=this;this.el.bind("keydown."+b,function(){a._keydownAutocomplete.apply(a,arguments)}).bind("keyup."+b,function(){a._keyupAutocomplete.apply(a,arguments)}).bind("blur."+b,function(){a._blurAutocomplete.apply(a,arguments)}).bind("focus."+b,function(){a._focusAutocomplete.apply(a,arguments)}).trigger("blur."+b)},_setupPlaceholder:function(){this.el.attr("placeholder")===void 0&&this.el.attr("placeholder",this._callFormatterMethod("placeholderValue",[],""))},_focusAutocomplete:function(){var b=a.trim(this.el.val()).substr(0,2);this.el.autocomplete("search",b)},_keydownAutocomplete:function(b){var c=a.trim(this.el.val()),d=[13,9,38,40];if(!~a.inArray(b.which,d)&&(8==b.which||c.length>1&&!~c.indexOf("h")&&!~c.indexOf(":")&&a.isNumeric(c)))try{this.el.autocomplete("close").autocomplete("disable")}catch(b){}},_keyupAutocomplete:function(){""==a.trim(this.el.val())&&this.el.autocomplete("enable")},_blurAutocomplete:function(){var c=a.trim(this.el.val());c=this._callFormatterMethod("blur",[c],c);var d="";d=c?this._createStringFromFormat(this._readMind(c)):this._callFormatterMethod("blurEmpty",[c],c),this.el.val(d),this._attacheUsableTimeData()},_attacheUsableTimeData:function(){var b=a.trim(this.el.val());this.el.data(c,this._callFormatterMethod("getUsableTimeValue",[b]))},setFormatter:function(b){if(this.options.formatter=b||this.options.formatter,!a.timeAutocomplete.formatters[this.options.formatter])throw Error("Formatter: '"+b+"' was not found. Make sure you're loading it (formatters/"+this.options.formatter+".js) after you load src/TimeAutocomplete.js");this._formatter=new a.timeAutocomplete.formatters[this.options.formatter](this,this.options),this._calling_from_init||this._callAutocomplete(),this._calling_from_init=!1},getFormatter:function(){return this._formatter},getTime:function(){return this.el.data(c)||""},_callFormatterMethod:function(b,c,d){var e=this.getFormatter();return a.isFunction(e["hook_"+b])?e["hook_"+b].apply(e,c):d},_readMind:function(a){return this._callFormatterMethod("readMind",[a],a)},_createStringFromFormat:function(a){var b=a.h+a.sep+a.m;return a.postfix&&(b+=a.postfix),b},_setCurrentTimeAsValue:function(){""==a.trim(this.el.val())&&this.options.value&&this.setTime(this.options.value)},setTime:function(a){var b=a.replace(/[^0-9.]/g,""),c=b.match(/^[0-9]+$/);if(!c||!c.length||5!=c[0].length&&6!=c[0].length)throw Error("Setting a time must be in H:i:s format. Example: 03:30:00");var d=this._callFormatterMethod("getTimeObjectFromHis",[a]);d=this._createStringFromFormat(d),this.el.val(d),this._attacheUsableTimeData()},_getCurrentTimeAsValue:function(){for(var b=this.getFormatter(),c=[1987,1,17],d=this._getCurrentDate(),e=d.getHours(),f=d.getMinutes(),g=new Date(c[0],c[1],c[2],e,f).getTime(),h=b.options.times.slice().concat(b.options.times),i=[],j=0,k=h.length;k>j;j++){var l=this._callFormatterMethod("getTime",[h[j],c]),m=h[j+1]?this._callFormatterMethod("getTime",[h[j+1],c]):!1,n=!(-1===a.inArray(m,i));if(i.push(m),g>l&&(m&&m>=g||n))return h[j+1]}},_getCurrentDate:function(){return new Date},destroy:function(){this.el.removeData(b),this.el.removeData(c),this.el.unbind("."+b),this.el.autocomplete("destroy")},render:function(){return this._calling_from_init=!0,this.setFormatter(),this._callAutocomplete(),this._setCurrentTimeAsValue(),this._bindEvents(),this._setupPlaceholder(),this}},a.timeAutocomplete={formatters:{},_raw:d},a.fn.timeAutocomplete=function(c){return this.each(function(){var e=a(this);e.data(b)&&e.data(b).destroy();var f=new d(e,c).render();e.data(b,f)})}})(jQuery);
// ampm formatter
(function(a){a.timeAutocomplete.formatters.ampm=function(){this.initialize.apply(this,arguments)},a.timeAutocomplete.formatters.ampm.prototype={main_instance:null,options:{},default_opts:{from_selector:"",increment:15,start_hour:0,end_hour:24,pm_text:"PM",am_text:"AM",blur_empty_populate:!0,times:[],empty:{h:"12",m:"00",sep:":",postfix:" PM"}},initialize:function(b,c){this.main_instance=b,this.options=a.extend(!0,{},this.default_opts,c),this.generateTimes()},hook_placeholderValue:function(){return this.main_instance._createStringFromFormat(this.options.empty)},hook_filterSource:function(b){var c=this;return function(c,d){return function(e,f){var g=a.trim(b.value),h=a.ui.autocomplete.escapeRegex(e.term),i=~h.toLowerCase().indexOf("a"),j=~h.toLowerCase().indexOf("p"),k="",l=!(1!=g),m=(i||j)&&2>=h.replace(/a|m|p/gi,"").length;m&&(h=a.trim(h.replace(/a|m|p/gi,""))+":00 ",h+=i?d.options.am_text:d.options.pm_text),d.options.from_selector&&(k=d.detectAMPMFromInstanceOverlap()==d.options.am_text?d.options.pm_text:d.options.am_text);var n=RegExp("^"+h,"i"),o=[];g&&(o=a.grep(c,function(a){var b=k&&RegExp(k,"gi").test(a)||l&&"1:"!=a.substring(0,2);if(!b)return n.test(a)})),f(o);var p=g.toLowerCase();if(!o.length&&(~p.indexOf("am")||~p.indexOf("pm"))){var q=~p.indexOf("am")?d.options.am_text:d.options.pm_text;p=p.replace(/a|m|p/gi,""),d.main_instance.el.val(p.split(" ")[0]+" "+q)}}}(c.options.times,c)},hook_blur:function(a){return 0==a.charAt(0)&&(a=a.substr(1)),a},hook_blurEmpty:function(){return this.options.blur_empty_populate?this.main_instance._createStringFromFormat(this.options.empty):""},hook_readMind:function(a){var b="";return a=a.toLowerCase(),!this.options.from_selector||~a.indexOf("a")||~a.indexOf("p")||(b=this.detectAMPMFromInstanceOverlap()),this.getTimeObject(a,b)},hook_getUsableTimeValue:function(a){return this.parseTime(a)},hook_getTime:function(a,b){var c=this.parseTime(a).split(this.options.empty.sep),d=c[0],e=c[1];return new Date(b[0],b[1],b[2],d,e).getTime()},hook_getTimeObjectFromHis:function(a){var b=a.split(":"),c=b[0],d=b[1],e=c>=12?"PM":"AM";2==(""+c).length&&10>c&&(c=c.substr(1));var f={h:c,m:d,sep:this.options.empty.sep,postfix:" "+e};return f},detectAMPMFromInstanceOverlap:function(){var b="",c=this.getTimeObject(a(this.options.from_selector).val()),d=this.getTimeObject(a.trim(this.main_instance.el.val()));if(c.postfix&&(~c.postfix.toLowerCase().indexOf("a")||~c.postfix.toLowerCase().indexOf("p"))){var e=~c.postfix.toLowerCase().indexOf("a")?this.options.am_text:this.options.pm_text,f=d.h,g=c.h;b=12==g&&12!=f?e==this.options.am_text?this.options.am_text:this.options.pm_text:12==f&&12!=g?e==this.options.am_text?this.options.pm_text:this.options.am_text:g>f?e==this.options.am_text?this.options.pm_text:this.options.am_text:e==this.options.am_text?this.options.am_text:this.options.pm_text}return b},getTimeObject:function(a,b){var f,c=this.parseTime(a,"g:i:A").split(":"),d=c[0],e=c[1];return f=d||e?{h:d,m:e,sep:":",postfix:" "+(b?b:c[2])}:this.options.empty},generateTimes:function(){if(!this.options.times.length){var a=60,b=this.options.increment,c=new Date(2012,1,1,this.options.start_hour-1,a-b),d=[],e=60,f=this.options.end_hour,g=f-this.options.start_hour,h=!1;24==g&&(h=!0);for(var i=0,j=g*(e/b);j>=i;i++){c.setMinutes(c.getMinutes()+b);var k=c.getHours(),l=c.getMinutes(),m=k>11?this.options.pm_text:this.options.am_text;0==k&&(k=12),k>12&&(k-=12),1==(""+l).length&&(l="0"+l);var n=k+":"+l+" "+m;d.push(n)}h&&d.pop(),this.options.times=d}},parseTime:function(a,b){var c,d,b=b||"H:i:s",e=null!==a.match(/p/i),f=a.replace(/[^0-9]/g,"");switch(f.length){case 4:c=parseInt(f[0]+f[1],10),d=parseInt(f[2]+f[3],10);break;case 3:c=parseInt(f[0],10),d=parseInt(f[1]+f[2],10);break;case 2:case 1:c=parseInt(f[0]+(f[1]||""),10),d=0;break;default:return""}if(12==c&&e===!1?c=0:e===!0&&c>0&&12>c&&(c+=12),0>=c&&(c=0),c>=24&&2==(""+c).length){var g=(""+c).split("");c=parseInt(g[0],10),d=parseInt(g[1],10),6>d&&(d+="0")}return(0>d||d>59)&&(d=0),c>=13&&23>=c&&(e=!0),b.replace(/g/g,0===c?"12":"g").replace(/g/g,c>12?c-12:c).replace(/h/g,(""+c).length>1?c>12?c-12:c:"0"+(c>12?c-12:c)).replace(/H/g,(""+c).length>1?c:"0"+c).replace(/i/g,(""+d).length>1?d:"0"+d).replace(/s/g,"00").replace(/A/g,e?this.options.pm_text:this.options.am_text)}}})(jQuery);
// 24hr formatter
(function(a){a.timeAutocomplete.formatters["24hr"]=function(){this.initialize.apply(this,arguments)},a.timeAutocomplete.formatters["24hr"].prototype={main_instance:null,options:{},default_opts:{increment:15,start_hour:"00",hour_max:24,blur_empty_populate:!0,times:[],empty:{h:"12",m:"00",sep:":",postfix:""}},initialize:function(b,c){this.main_instance=b,this.options=a.extend(!0,{},this.default_opts,c),this.generateTimes()},hook_placeholderValue:function(){return this.main_instance._createStringFromFormat(this.options.empty)},hook_getTime:function(a,b){var c=a.split(this.options.empty.sep),d=c[0],e=c[1];return new Date(b[0],b[1],b[2],d,e).getTime()},hook_getTimeObjectFromHis:function(a){var b=a.split(":"),c=b[0],d=b[1],e={h:c,m:d,sep:this.options.empty.sep};return e},hook_filterSource:function(b){var c=this;return function(c,d){return function(e,f){var g=a.trim(b.value);1==e.term.length&&10>e.term.substr(0,1)&&(e.term="0"+e.term);var h=a.ui.autocomplete.escapeRegex(e.term),i=RegExp("^"+h,"i"),j=[];g&&(j=a.grep(c,function(a){return 0==a.substr(0,1)&&1==a.length&&(a=a.substr(1)),i.test(a)})),f(j);var k=g.toLowerCase();!j.length&&k.length>5&&d.main_instance.el.val(k.substr(0,5))}}(c.options.times,c)},hook_blurEmpty:function(){return this.options.blur_empty_populate?this.main_instance._createStringFromFormat(this.options.empty):""},hook_readMind:function(a){return a=a.toLowerCase(),this.getTimeObject(a)},hook_getUsableTimeValue:function(a){return a+":00"},getTimeObject:function(a){var b="",c="",d="";if(~a.indexOf("h")){var e=a.split("h");b=e[0]?e[0]:this.options.empty.h,c=e[1]?e[1]:this.options.empty.m}else{var f=a.replace(/[^\d]/g,"");f=f.split(""),4==f.length?(b=f[0]+f[1],c=f[2]+f[3]):3==f.length?(b="0"+f[0],c=f[1]+f[2]):2==f.length?(b=f.join(""),c="00"):1==f.length&&(b=f.join(""),c="00")}return b>24&&"00"==c&&(b=b.split(""),c=b[1]+"0",b="0"+b[0]),1==b.length&&(b="0"+b),1==c.length&&(c+="0"),d=b||c?{h:b,m:c,sep:this.options.empty.sep}:this.options.empty},generateTimes:function(){if(!this.options.times.length){for(var a=60,b=this.options.increment,c=new Date(2012,1,1,this.options.start_hour-1,a-b),d=[],e=60,f=this.options.hour_max,g=0,h=f*(e/b);h>g;g++){c.setMinutes(c.getMinutes()+b);var i=c.getHours(),j=c.getMinutes();1==(""+i).length&&(i="0"+i),1==(""+j).length&&(j="0"+j);var k=i+this.options.empty.sep+j;d.push(k)}this.options.times=d}}}})(jQuery);
// french formatter
(function(a){a.timeAutocomplete.formatters.french=function(){this.initialize.apply(this,arguments)},a.timeAutocomplete.formatters.french.prototype=a.extend(!0,{},a.timeAutocomplete.formatters["24hr"].prototype,{default_opts:{empty:{sep:"h"}},hook_getUsableTimeValue:function(a){return a.replace(this.options.empty.sep,":")+":00"}})})(jQuery);
